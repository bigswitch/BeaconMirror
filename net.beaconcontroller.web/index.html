<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Beacon</title>
    <link type="text/css" href="css/layout/layout.css" rel="stylesheet" />
    <link type="text/css" href="css/smoothness/jquery-ui-1.8.5.custom.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.5.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.layout.js"></script>
    <script type="text/javascript" src="js/jquery.values.js"></script>
    <script type="text/javascript" src="js/jquery.xclone.js"></script>
    <script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
    
    <!-- TODO - move these back to dynamically loaded scripts (here for debugger) -->
    
    <script type="text/javascript" src="js/jit.js"></script>
    <script type="text/javascript" src="js/excanvas.js"></script>
    
    <style type="text/css">
      /* set base body font size so that the relative font sizing below works */
      body {font-size: 12px}

      /* neutralize pane formatting BEFORE loading UI Theme */
      .ui-layout-pane, ui-layout-content {
        background: rgb(250, 250, 250);
        border:   0;
        padding:  0;
        overflow: auto;
      }

      p       { margin: 1em 0; }
      /* use !important to override UI theme styles */
      .grey     { background: #999 !important; }
      .outline    { /*border:   1px dashed #F00 !important;*/ }
      .add-padding  { padding:    10px !important; }
      .no-padding   { padding:    0 !important; }
      .add-scrollbar  { overflow:   auto; }
      .no-scrollbar { overflow:   hidden; }
      .allow-overflow { overflow:   visible; }
      .full-height  { height:   100%; }
      .ui-layout-west h3 a { font-size: 120% !important; font-weight: bolder !important;}

      .two_column .column {float: left; width: 50%; padding-bottom: 10px;}
      .section { margin: 0 1em 1em 1em; border: 0px}
      .section-header { margin: 0.3em; padding-bottom: 4px; padding-left: 0.2em; }
      .section-header .ui-icon { float: right; }
      .section-content { width: 100%; height: 100%; padding: 0.1em; } //set height/width so children's % spec will be relative to section-content not column
      .ui-sortable-placeholder { border: 1px dotted black; visibility: visible !important; height: 50px !important; }
      .ui-sortable-placeholder * { visibility: hidden; }

      /* style the close button for tabs */
      #tabs li .ui-icon-close { float: left; margin: 0 0 0 -1em; cursor: pointer; }

      /* set styles for the beacon templating */
      .beaconTable {width: 100%; height: 100%;}

      /* set style fix-up for datatables plug-in */
      .css_right {float:right;}
      .css_left {float:left;}
      .rowHover {background-color: #ededed;}
    </style>

    <script type="text/javascript">
      var APPLICATIONS_LIST_URI = "wm.do";

      /**
      * Removes all of the tabs from the main panel and replaces them with the tabs referenced
      * here.  Takes an array of tab objects {url: "some URL", title: "some string"}
      **/
      function newTabs(tabSet) {
        //remove all existing tabs
        $tabs = $("#center");
        while($tabs.tabs("length") > 0)
          $tabs.tabs("remove", 0);

        //Add in the tabs that came with the tab set
        for(var i = 0; i < tabSet.length; i++) {
          $tabs.tabs('add', tabSet[i].url, tabSet[i].title);
        }
      };
      

      /**
       * Registers a "decorator" -- this is basically a small function that is given a matching dom element as an argument
       * every time a tab is loaded (or refreshed).  The string "selector" uses jquery syntax to find the dom element.  The callback
       * should have the signature callback(element, params) where element is the DOM element matched by the selector string and
       * params is a map of key/value strings that came from the back end as html param elements.
       * 
       * (put example here)
       *
       * Note that if two decorators register for the same selectorString, only one of them will get called (i.e. stay out of the 
       * global namespace if your decorators are application specific!)
       */
      var decorators = {};
      function registerDecorator(selectorString, callback) {
        decorators[selectorString] = callback;
      };
      
      function getDecorators() {
        return decorators;
      };
      
      /**
       * Implementation of a simple script loader to pull in js files dynamically
       * (used only when loading tabs)
       */
      var scriptFilesQueued = [];
      var scriptFilesLoaded = "";
      var scriptOnLoadCallbacks = [];
      
      function loadScript(pathToJs) {
        scriptFilesQueued.push(pathToJs);
      };
      function loadScripts(callbackWhenDone) {
        var scriptPath = scriptFilesQueued.pop();
        
        if(!scriptPath) {
          callbackWhenDone();
          return;
        }
        
        
        if(scriptFilesLoaded.indexOf(scriptPath) == -1 ) {
          scriptFilesLoaded += "[" + scriptPath + "]";
          $.getScript(scriptPath, function() {
            loadScripts(callbackWhenDone);
          });
        }
        else {
          loadScripts(callbackWhenDone); //if the script is already loaded, just continue recursion
        }
      };

      

      /**
       * Primary method where client-side templating is applied.
       *
       * Processing step that will go through the html used in a freshly loaded application's tab and decorate it
       * with the css classes or jquery functionality to change the nice semantic html in to something
       * with a bit more flash.
       *
       *
       * tab should be a dom element representing the contents of a single tab
       */
      function decorateTab(tab) {
        var decorators = getDecorators();
        for(var selectorString in decorators) {
          var decoratorCallback = decorators[selectorString];
          $(tab).find(selectorString).each(function(index, el) {
            var params = {};
            $(this).children("param").each(function(index, el){
              var key = $(el).attr("name");
              var val = $(el).attr("value");
              params[key] = val;
            });
            decoratorCallback(el, params);
          });
        }
      };
      
      /**
       * Sends an event to all of the elements matching a registered decorator - for advanced
       * decorator use.
       * Example: inside a decorator:
       * var timerId;
       *  $(el).bind("tabLoad", function(){
       *   timerId = setInterval(function () {
       *     $.getJSON(seriesDataPath, function(seriesData){
       *       beaconChart.loadJSON(seriesData);
       *     });
       *   }, 5000);
       * });
       *
       * $(el).bind("tabHide", function(){
       *   clearInterval(timerId);
       * });
       */
      function sendBeaconEvent(tab, eventName, extraParams) {
        var decorators = getDecorators();
        for(var selectorString in decorators) {
          //console.log("Sending event to selector string: " + selectorString + " " + eventName);
          $(tab).find(selectorString).each(function(index, el) {
            $(el).trigger(eventName, extraParams);
          });
        }
      };
      
      
      
      
      $(document).ready(function () {

        
        /**
         * Decoration defaults
         */
        registerDecorator(".column", function(el, params) {
          $(el).sortable({
            connectWith: '.column',
          });
          $(el).disableSelection();
        });
        
        registerDecorator(".section", function(el, params) {
          $(el).addClass("ui-widget ui-widget-content ui-helper-clearfix ui-corner-all");
          $(el).find(".section-header")
              .addClass("ui-widget-header ui-corner-all")
              .prepend('<span class="ui-icon ui-icon-minusthick"></span>');
        });
        
        registerDecorator(".section-header .ui-icon", function(el, params) {
          $(el).click(function() {
            $(this).toggleClass("ui-icon-minusthick").toggleClass("ui-icon-plusthick");
            $(this).parents(".section:first").find(".section-content").toggle();
          });
        });
        
        registerDecorator(".beaconTable", function(el, params) {
          $(el).dataTable({
            bJQueryUI: true,
            bPaginate: false,
            bLengthChange: true,
            bFilter: false,
            bSort: true,
            bInfo: true,
            bRetrieve: true, //if this table already exists, retrieve it rather than creating a new one
          });
          
          //add a hover over rows.
          $(el).find("tr").hover(function () {
            $(this).toggleClass("rowHover");
          });
        });
        
        
        //Wrap up any dialog box-oriented buttons (see SimpleWebManageableTemplate.wrapWithDialogBox for more detail)
        registerDecorator(".beaconGetDialog", function(el, params) {
          $(el).click(function() {
            var url = $(this).attr("href");
            $.get(url, function(response) {
              $("#beaconDialogBoxTemplate" ).html(response);
              $("#beaconDialogBoxTemplate" ).dialog({
                height: 140,
                modal: true,
                resizable: false,
                buttons: {
                  OK: function() {
                    $( this ).dialog( "close" );

                    //reload the currently open tab
                    var $tabs = $('#center').tabs();
                    var selectedIndex = $tabs.tabs('option', 'selected');
                    $tabs.tabs('load', selectedIndex);
                  }
                }
              });
            });
            return false; //Return false from the click method to stop any native browser processing
          }); // close the click() inner function
        }); //close the decorator function
        
        // Wrap a refresh link
        registerDecorator(".beaconRefreshTab", function(el, params) {
          $(el).click(function() {
            var url = $(this).attr("href");
            $.get(url, function(response) {
              //reload the currently open tab
              var $tabs = $('#center').tabs();
              var selectedIndex = $tabs.tabs('option', 'selected');
              $tabs.tabs('load', selectedIndex);
            });
            return false; //Return false from the click method to stop any native browser processing
          }); // close the click() inner function
        }); //close the each() loop
        
        
        // Wrap a new refreshing tab link
        registerDecorator(".beaconNewRefreshingTab", function(el, params) {
          $(el).click(function() {
            $tabs = $("#center");

            // add the new tab
            var oldTemplate = $tabs.tabs( "option", "tabTemplate");
            // use a custom template with an x to close the tab
            $tabs.tabs( "option", "tabTemplate", '<li><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>');
            var t = $tabs.tabs('add', $(this).attr("href"), $(this).attr("name"));
            $tabs.tabs( "option", "tabTemplate", oldTemplate);
            // select it
            var index = $tabs.tabs("length")-1;
            $tabs.tabs("select", index);
            // refresh every 5 seconds if we are selected
            var timerId = setInterval(function () {
              if (index == $tabs.tabs('option', 'selected')) {
                $tabs.tabs('load', index);
              }
            }, 5000);

            // add the close handler
            $('#center span.ui-icon-close').last().click(function() {
              var index = $('li',$tabs).index($(this).parent());
              $tabs.tabs('remove', index);
              clearInterval(timerId);
            });
            return false; //Return false from the click method to stop any native browser processing
          }); // close the click() inner function
        }); //close the each() loop
        
        
        
        // Wrap a new  tab link
        registerDecorator(".beaconNewTab", function(el, params) {
          $(el).click(function() {
            $tabs = $("#center");

            // add the new tab
            var oldTemplate = $tabs.tabs( "option", "tabTemplate");
            // use a custom template with an x to close the tab
            $tabs.tabs( "option", "tabTemplate", '<li><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>');
            var t = $tabs.tabs('add', $(this).attr("href"), $(this).attr("name"));
            $tabs.tabs( "option", "tabTemplate", oldTemplate);
            // select it
            var index = $tabs.tabs("length")-1;
            $tabs.tabs("select", index);

            // add the close handler
            $('#center span.ui-icon-close').last().click(function() {
              var index = $('li',$tabs).index($(this).parent());
              $tabs.tabs('remove', index);
            });
            return false; //Return false from the click method to stop any native browser processing
          }); // close the click() inner function
        }); //close the each() loop

      
    }); //end document ready for registerDecorators
    </script>
    
    <script type="text/javascript">
    $(document).ready(function () {
      // OUTER/PAGE LAYOUT
      pageLayout = $("body").layout({
          west__size:       250
        , east__size:       .10
        , north__size:      50
        , south__size:      30
        , south__initClosed:    false
        , north__initClosed:    false
        , east__initClosed:   true
        , west__onresize:     function () { $("#accordion-west").accordion("resize"); }
        , togglerLength_open:   50
        , togglerLength_closed: 50
        , spacing_open:     0
        ,   spacing_closed:     0
      });

      var currentTab;
      // Center panel - set up tabs
      $("#center").tabs({
        //Hooks up the tab panel decoration code to run when tabs are loaded from remote
        load: function(event, ui) {
          var newTab = ui.panel;
          sendBeaconEvent(currentTab, "tabHide", {});
          window.loadScripts(function(){
            decorateTab(newTab); // set up callback chain to makes ure libs are loaded before decorate
            sendBeaconEvent(newTab, "tabLoad", {});
            currentTab = newTab;
          });
         },
         remove: function(event, ui) {
           var tab = ui.panel;
           sendBeaconEvent(currentTab, "tabRemove", {});
          },
      });

      pageLayout.sizeContent("east"); // resize pane-content-elements after creating tabs


      //Retrieve the app list from the server
      $.get(APPLICATIONS_LIST_URI, function(appList, status) {
        firstTabSet = appList[0].tabs;

        //Fetch the content for the tabs needed
        newTabs(firstTabSet);
        
        //Init the left panel nav (copy in values and do a little html munging)
        for(var i = 0; i < appList.length; i++) {
          $("#appAccordianEntryTemplate").values(appList[i], {onlyNest:true});
          $("#appAccordian").append($("#appAccordianEntryTemplate").clone().children()); //work around to make accordian plugin line up with values plug-in
        }
        $("#appAccordian").accordion({ });

        // Wire the accordian change in the left panel nav to changing up the tabs in the center panel
        $("#appAccordian").bind( "accordionchange", function(event, ui) {
          var name = ui.newHeader.find("a").html(); //crumby way to fish the app name back out
          var app = null;
          for(var i = 0; i < appList.length; i++)
          if (appList[i].name == name)
            app = appList[i];
          if(app)
            newTabs(app.tabs);
        });
      });
    });

    /**
     * Set this to true only after all libraries have loaded
     */
    allLibrariesLoaded = false;
    $(window).load(function() {
       window.allLibrariesLoaded = true;
    });

    </script>
  </head>
  <body>
    <div id="header" class="ui-layout-north add-padding">
      <div id="logo" style="position: absolute; left:50px; top:0px">
      	<img src="images/beacon_logo.png" style="position:absolute; top: 0px; left: 4px; z-index: 5;"/>
      </div>
    </div>

    <div id="footer" class="ui-layout-south">
      <div class="ui-widget-header" style="height:100%; margin:0px; padding:0px">
        <p style="text-align:center; font-size:smaller"><a href="http://www.beaconcontroller.net">www.beaconcontroller.net</a></p>
      </div>
    </div>

    <div id="west" class="ui-layout-west no-scrollbar add-padding">
      <div id="appAccordian">
      </div>
    </div>

    <div id="center" class="ui-layout-center add-padding">
      <div id="tabs" class="ui-widget-content ui-corner-all" style="min-height:600px">
        <ul>
        </ul>
      </div>
      <div class="ui-helper-clearfix ui-helper-reset"></div>
    </div>

    <!-- The items in this div are templates used by the xclone/values plugin they should not be end-user-visible  -->
    <div id="templatesDiv" style="visibility:hidden">
      <!-- Template for the accordian control (west panel) used to pick active application -->
      <div id="appAccordianEntryTemplate">
        <h3><a name="name" href="#">Section 1</a></h3>
        <div name="description">
          <p>description</p>
        </div>
      </div>
      <!-- Template for dialog boxes -->
      <div id="beaconDialogBoxTemplate">
      </div>
    </div>

  </body>
</html>
